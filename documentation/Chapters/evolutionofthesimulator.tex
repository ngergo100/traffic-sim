\chapter{Evolution of the simulator}
	\section{Basic 2 car setup with IDM}\label{sec:base2car}
		Equation \ref{eq:numerical_idm} can be solved with an Explicit Euler. To test the model a basic setup was implemented in \textsc{Matlab}. The visual representation of the setup can be seen on figure \ref{fig:basic2car}.
		\begin{figure}[ht]
			\centering
			\includegraphics[width=.95\textwidth]{common/basic_2_car}
			\caption{Basic setup with 2 cars}
			\label{fig:basic2car}
		\end{figure}
		The leading car has a constant 100 km/h velocity. The following car - which is modeled with IDM - has an initial velocity of 100 km/h as well. The second car is 100 meters behind the other car. The parameters of following car can be seen in Table \ref{tab:idm_params}. The parameters have been chosen based on literature from [TODO:reference here].
		\begin{table}[ht]
			\begin{center}
				\begin{tabular}{ |c|c|c| }
					\hline
					$a_{\rm max}$ & $1.5$ & $\rm m/s^2$ \\
					$b_{\rm max}$ & $1.67$ & $\rm m/s^2$ \\
					$v_{\rm d}$ & $130$ & km/h \\
					$T$ & $1.8$ & s \\
					$h_0$ & $2$ & m \\
					$\rm \delta$ & $4$ & - \\
					$L$ & $4.5$ & m \\
					\hline
				\end{tabular}
			\end{center}
			\caption{Intelligent Driver Model parameters}
			\label{tab:idm_params}
		\end{table}
		The simulation was run until 100 seconds. Figure \ref{fig:basic2car_case_1} shows the result. The initial gap between the cars is greater than the second car's desired headway, consequently the vehicle will accelerate. The gap between the vehicles starts to decrease. At a certain time (around $t =$ 10) the second car starts to decelerate slowly based on the velocity difference and the decreasing headway. It will reach the desired safe gap at some point and will have exactly the same speed as the car before. It will maintain its desired headway.
		\begin{figure}[ht]
			\centering
			\begin{minipage}{.5\textwidth}
				\centering
				\includegraphics{ee/basic_2_car_headaway_case_1_2}
			\end{minipage}\hfill
			\begin{minipage}{.5\textwidth}
				\centering
				\includegraphics{ee/basic_2_car_velocity_case_1_2}
			\end{minipage}
			\caption{Following car's headway and velocity in Setup 1}
			\label{fig:basic2car_case_1}
		\end{figure}

		Another simulation was run with the same configuration except that the first car's front is set to be at 40 meters instead of 100. Figure \ref{fig:basic2car_case_2} shows the result. In this case the gap between cars is less than the second vehicle's desired safety headway. So it will decelerate first than accelerate to reach the desired gap. Fundamentally the same happened but in the opposite direction.
		\begin{figure}[ht]
			\centering
			\begin{minipage}{.5\textwidth}
				\centering
				\includegraphics{ee/basic_2_car_headaway_case_2_2}
			\end{minipage}\hfill
			\begin{minipage}{.5\textwidth}
				\centering
				\includegraphics{ee/basic_2_car_velocity_case_2_2}
			\end{minipage}
			\caption{Following car's headway and velocity in Setup 2}
			\label{fig:basic2car_case_2}
		\end{figure}
		Both examples showed that the stationary state does not depend on the initial gap. After a little bit of time the second car has reached the desired safety gap (which is around 64.5 meters) and the 100 km/h speed in both cases.
	\section{Model behavior verification}
		In Section \ref{sec:base2car} two examples were shown where the model produced the same stationary state for different initial conditions. Stationary state means that the vehicle's acceleration is zero. So equation \ref{eq:aidm} modifies as followings in a stationary state:
		\begin{equation}
		1 - \left ( \frac{v_{\rm stac}}{v_{\rm d}} \right )^{\rm \delta} - \left ( \frac{h_0+v_{\rm stac}\cdot T+\frac{v_{\rm stac}(v_{\rm l,stac}-v_{\rm stac})}{2\sqrt{\amax \bmax}}}{x_{\rm l,0}+v_{\rm l, stac}\cdot t-x_{0} - L_{\rm l} - v_{\rm stac}\cdot t} \right )^2=0\,,
		\label{eq:aidm_stac1}
		\end{equation}
		There is an other consequence of this situation as well. As it can be seen in the examples, cars' velocities were equal, which means:
		\begin{equation}
			v_{\rm stac}=v_{\rm l,stac}\,,
		\end{equation}
		so Equation \ref{eq:aidm_stac1} further simplifies to:
		\begin{equation}
			1 - \left ( \frac{v_{\rm stac}}{v_{\rm d}} \right )^{\rm \delta} - \left ( \frac{h_0+v_{\rm stac}\cdot T}{x_{\rm l,0}-x_{0} - L_{\rm l}} \right )^2=0\,.
			\label{eq:aidm_stac2}
		\end{equation}
		It can be stated that the stationary gap between the vehicles equals to the denominator of the second fraction expression:
		\begin{equation}
		x_{\rm l,0}-x_{0} - L_{\rm l}=h_{\rm stac}\,.
		\label{eq:aidm_stac3}
		\end{equation}
		Expressions \ref{eq:aidm_stac2} and \ref{eq:aidm_stac3} show that $v_{\rm stac}$ only depends on $h_{\rm stac}$. Everything else in the equations is a parameter of the model or initial condition. Consequently every stationary gap has a corresponding speed value. Using \textsc{Matlab} fsolve method Equation \ref{eq:aidm_stac2} can be solved. Plot of the result can be seen on Figure \ref{fig:aidm_stac}.
		\begin{figure}[ht]
			\centering
			\includegraphics{check/check_stationary_states}
			\caption{Stationary velocity based on stationary headway}
			\label{fig:aidm_stac}
		\end{figure}

		In the examples of Section \ref{sec:base2car} the stationary gap between the vehicles was around 64.5 meters and the velocity was 100 km/h. Figure \ref{fig:aidm_stac} shows exactly the same values. It can be stated that the model and the numerical solver is working as expected. Note that the bumper to bumper or traffic jam distance ($h_0$) appears on the horizontal axis and it has a zero velocity value.
	\section{Solver verification}
		A custom Explicit Euler solver was implemented to solve equation \ref{eq:numerical_idm} numerically. However \textsc{Matlab} provides built-in solvers for differential equation systems like IDM. It has a solver called ode45. It is a 4th order numerical solver which is capable of changing some of its parameters (e.g.: time step) based on the system's behavior. So theoretically it is a better choice over a custom implemented Explicit Euler to solve differential equation systems. It also provides a verification to the custom implemented solver. 
		\begin{figure}[ht]
			\centering
			\begin{minipage}{.5\textwidth}
				\centering
				\includegraphics{ode/basic_2_car_headaway_case_1_2}
			\end{minipage}\hfill
			\begin{minipage}{.5\textwidth}
				\centering
				\includegraphics{ode/basic_2_car_velocity_case_1_2}
			\end{minipage}
			\caption{Following car's headway and velocity in Setup 1 with ode45}
			\label{fig:basic2car_case_1_ode}
		\end{figure}
		\begin{figure}[ht]
			\centering
			\begin{minipage}{.5\textwidth}
				\centering
				\includegraphics{ode/basic_2_car_headaway_case_2_2}
			\end{minipage}\hfill
			\begin{minipage}{.5\textwidth}
				\centering
				\includegraphics{ode/basic_2_car_velocity_case_2_2}
			\end{minipage}
			\caption{Following car's headway and velocity in Setup 2  with ode45}
			\label{fig:basic2car_case_2_ode}
		\end{figure}

		The same two examples were implemented with ode45 as before in Section \ref{sec:base2car} with EE.
		It can be seen on Figure \ref{fig:basic2car_case_1_ode} and \ref{fig:basic2car_case_2_ode} that the solutions are exactly the same as before, consequently the custom made solver is working as expected.
	\section{Solution for n cars}
		The simulator works as expected for 2 cars simulations. It is time to implement an n-car simulation as well. The simulator still uses the built-in ode45 function to solve the differential equation system. However the dimension of the system grows from 4 to 2n. The visual representation of the setup can be seen on Figure \ref{fig:basic_n_car}.
		\begin{figure}[ht]
			\centering
			\includegraphics[width=\textwidth]{common/basic_n_car}
			\caption{n-car setup}
			\label{fig:basic_n_car}
		\end{figure}
		Unfortunately the previously used implementation is not enough to solve this system since the cross dependence between the equation. Namely, to be able to calculate vehicle n's position and velocity it needs to have vehicle n-1's position and velocity. Mathematically it looks the following:
		\begin{equation}
			\begin{pmatrix}
				v_{\rm 1_i}\\
				a_{\rm 1_i}\\
				v_{\rm 2_i}\\
				a_{\rm 2_i}\\
				v_{\rm n-1_{i}}\\
				a_{\rm n-1_{i}}\\
				v_{\rm n_i}\\
				a_{\rm n_i}
			\end{pmatrix}
			=
			\begin{pmatrix}
				v_{0}\\
				0\\
				a_{2_{i-1}}\\
				idm(v_{2_{i-1}}, x_{2_{i-1}},v_{1_{i-1}}, x_{1_{i-1}})\\
				a_{\rm n-1_{i-1}}\\
				idm(v_{n-1_{i-1}}, x_{n-1_{i-1}},v_{n-2_{i-1}}, x_{n-2_{i-1}})
				a_{\rm n_{i-1}}\\
				idm(v_{n_{i-1}}, x_{n_{i-1}},v_{n-1_{i-1}}, x_{n-1_{i-1}})
			\end{pmatrix}\,.
			\label{eq:n_ode_math}
		\end{equation}
		\begin{figure}[ht]
			\centering
			\begin{minipage}{.5\textwidth}
				\centering
				\includegraphics{node/n_car_headway_case1}
			\end{minipage}\hfill
			\begin{minipage}{.5\textwidth}
				\centering
				\includegraphics{node/n_car_velocity_case1}
			\end{minipage}
			\caption{6 car accelerating}
			\label{fig:node_case1}
		\end{figure}
		\begin{figure}[ht]
			\centering
			\begin{minipage}{.5\textwidth}
				\centering
				\includegraphics{node/n_car_headway_case2}
			\end{minipage}\hfill
			\begin{minipage}{.5\textwidth}
				\centering
				\includegraphics{node/n_car_velocity_case2}
			\end{minipage}
			\caption{6 car decelerating}
			\label{fig:node_case2}
		\end{figure}
		\begin{figure}[ht]
			\centering
			\begin{minipage}{.5\textwidth}
				\centering
				\includegraphics{node/n_car_headway_case3}
			\end{minipage}\hfill
			\begin{minipage}{.5\textwidth}
				\centering
				\includegraphics{node/n_car_velocity_case3}
			\end{minipage}
			\caption{6 car accelerating and decelerating randomly}
			\label{fig:node_case3}
		\end{figure}